# React SPA + Laravel API Architecture

This project uses a **separated React SPA frontend** with a **Laravel API-only backend**.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────┐
│                    React SPA (Frontend)                  │
│  - Client-side routing (React Router)                   │
│  - Built: http://localhost/  (production build)         │
│  - Dev:   http://localhost:8383/ (Vite HMR)            │
│  - Dev:   http://localhost/ (proxied to 8383)          │
└──────────────────┬──────────────────────────────────────┘
                   │ /api/* requests
                   ▼
┌─────────────────────────────────────────────────────────┐
│              Laravel API Backend                         │
│  - API routes in `routes/api.php`                       │
│  - No web routes (SPA is client-routed)                │
│  - Port: 9000 (PHP-FPM, internal)                      │
│  - All endpoints behind /api/ prefix                    │
└─────────────────────────────────────────────────────────┘
```

## URLs and Access

### Development

- **SPA Dev (with HMR)**: `http://localhost:8383/`
  - Vite dev server with hot module replacement
  - Any changes to React components auto-reload

- **SPA via nginx**: `http://localhost/`
  - Proxied to the Vite dev server (http://localhost:8383)
  - Use this if you prefer a single localhost URL

### Production

- **SPA Built Assets**: `http://localhost/`
  - Serves optimized production build from `public/build/`
  - Once you run `npm run build` inside the node container

## Frontend Routes vs API Routes

### Frontend Routes (Client-side Navigation)

Used for React Router navigation. **No `/api` prefix**.

```typescript
import { login, register, dashboard } from '@/routes';

// In React components:
<Link to={login.url()}>Login</Link>
// Generates: /login

<Link to={register.url()}>Register</Link>
// Generates: /register
```

### API Routes (Backend Calls)

Used for fetch/axios to communicate with Laravel. **Must prefix with `/api`**.

```typescript
import { logout, login, register } from '@/routes';
import { apiUrl, apiRoute } from '@/wayfinder';

// Method 1: Use apiUrl() helper
const response = await fetch(apiUrl(logout.url()), {
  method: 'POST',
  credentials: 'include',
  headers: { 'Content-Type': 'application/json' }
});

// Method 2: Use apiRoute() helper (returns object with prefixed url)
const route = apiRoute(logout());
// { url: '/api/logout', method: 'post' }

// Method 3: Manual /api/ prefix
fetch('/api/login', {
  method: 'POST',
  body: JSON.stringify({ email, password }),
  credentials: 'include'
})
```

## How Routes Work

### Route Generation

Routes are auto-generated from Laravel's route definitions by the **Wayfinder** plugin:

1. **Source**: `routes/api.php` and `routes/web.php` in Laravel
2. **Generated**: `resources/js/routes/index.ts` (auto-generated, do not edit)
3. **Usage**: Import route functions in React components

### Example

**Laravel Route** (`routes/api.php`):
```php
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/logout', [LogoutController::class, 'logout']);
    Route::get('/user', [UserController::class, 'show']);
});
```

**Generated Route** (`resources/js/routes/index.ts`):
```typescript
export const logout = (options?: RouteQueryOptions): RouteDefinition<'post'> => ({
    url: logout.url(options),
    method: 'post',
})

export const user = (options?: RouteQueryOptions): RouteDefinition<'get'> => ({
    url: user.url(options),
    method: 'get',
})
```

**Usage in React** (`resources/js/pages/auth/login.tsx`):
```typescript
import { logout, user } from '@/routes';
import { apiUrl } from '@/wayfinder';

// Get current user
const userData = await fetch(apiUrl(user.url())).then(r => r.json());

// Logout
const response = await fetch(apiUrl(logout.url()), { method: 'POST' });
```

## File Structure

```
vivubus-app/
├── resources/
│   └── js/
│       ├── routes/              # Auto-generated by Wayfinder
│       │   ├── index.ts         # All route helpers
│       │   ├── login/
│       │   ├── register/
│       │   ├── two-factor/
│       │   └── ...
│       ├── wayfinder/           # Route generation utilities
│       │   └── index.ts         # apiUrl(), apiRoute() helpers
│       ├── pages/               # React page components
│       ├── components/          # Reusable React components
│       ├── hooks/               # Custom React hooks
│       ├── app.tsx              # React app entry
│       └── ...
├── routes/
│   ├── api.php                  # All backend API endpoints
│   ├── web.php                  # (mostly empty for SPA)
│   └── ...
└── ...
```

## Development Workflow

### 1. Start Services

```bash
docker compose up
```

This starts:
- **vivubus-app**: PHP-FPM backend (port 9000, internal)
- **vivubus-db**: MySQL database (port 3306, internal)
- **vivubus-web**: nginx proxy (port 80)
- **vivubus-node-watch**: Vite dev server (port 8383)
- **vivubus-node**: Production build watcher

### 2. Development

#### Option A: Use `http://localhost:8383/` (Vite HMR)
```bash
# Edit React component
# Change reflected immediately in browser without full page reload
```

#### Option B: Use `http://localhost/` (nginx proxy to Vite)
```bash
# Same HMR experience, just different URL
```

### 3. Add New API Endpoint

**Step 1**: Add Laravel route in `routes/api.php`
```php
Route::middleware('auth:sanctum')->post('/profile/update', [ProfileController::class, 'update']);
```

**Step 2**: Regenerate routes
```bash
docker exec vivubus-app php artisan wayfinder:generate --with-form
```

**Step 3**: Use in React
```typescript
import { profileUpdate } from '@/routes/profile';
import { apiUrl } from '@/wayfinder';

const response = await fetch(apiUrl(profileUpdate.url()), {
  method: 'POST',
  body: JSON.stringify(formData),
  credentials: 'include'
});
```

### 4. Build for Production

```bash
# Build the React SPA
docker exec vivubus-node-watch npm run build

# Restart nginx to serve the built assets
docker compose restart web
```

After build, `http://localhost/` serves the production-optimized React bundle from `public/build/`.

## Testing API Endpoints

### Test a simple API endpoint

```bash
# GET request
curl -i http://localhost/api/user

# POST request with auth
curl -i -X POST http://localhost/api/logout \
  -H "Content-Type: application/json" \
  -H "Cookie: XSRF-TOKEN=...; laravel_session=..."
```

### From React component

```typescript
import { apiUrl, apiRoute } from '@/wayfinder';
import { logout } from '@/routes';

export function LogoutButton() {
  const handleLogout = async () => {
    const response = await fetch(apiUrl(logout.url()), {
      method: 'POST',
      credentials: 'include', // Include cookies for session auth
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      window.location.href = login.url(); // Redirect to login
    }
  };

  return <button onClick={handleLogout}>Logout</button>;
}
```

## Key Helpers and Functions

### `apiUrl(route)`
Converts a frontend route URL to API-prefixed URL.

```typescript
apiUrl(logout.url())        // '/api/logout'
apiUrl('/logout')           // '/api/logout'
apiUrl('/api/logout')       // '/api/logout' (already has /api)
```

### `apiRoute(route)`
Returns a route object with API-prefixed URL and method.

```typescript
const r = apiRoute(logout());
// { url: '/api/logout', method: 'post' }
```

### Route functions
Auto-generated from Laravel routes.

```typescript
import { login, logout, register, user } from '@/routes';

login.url()           // '/login' (frontend route)
logout.url()          // '/logout' (frontend route)
user.url()            // '/user' (frontend route)

// With method access:
logout.post()         // { url: '/logout', method: 'post' }
user.get()            // { url: '/user', method: 'get' }
```

## Migration from Inertia to API

If migrating from Inertia forms to API calls:

### Before (Inertia Form)
```typescript
import { Form } from '@inertiajs/react';
import { logout } from '@/routes';

export default function Header() {
  return (
    <Form {...logout.form()} method="post">
      <button type="submit">Logout</button>
    </Form>
  );
}
```

### After (API Call)
```typescript
import { apiUrl } from '@/wayfinder';
import { logout } from '@/routes';
import { useNavigate } from 'react-router-dom'; // or similar

export default function Header() {
  const navigate = useNavigate();

  const handleLogout = async () => {
    const response = await fetch(apiUrl(logout.url()), {
      method: 'POST',
      credentials: 'include',
    });

    if (response.ok) {
      navigate(login.url()); // Navigate client-side
    }
  };

  return <button onClick={handleLogout}>Logout</button>;
}
```

## Common Issues & Solutions

### Issue: API returns 401 Unauthorized
**Solution**: Ensure credentials are included and session/token is valid
```typescript
fetch(apiUrl(logout.url()), {
  method: 'POST',
  credentials: 'include'  // ← Important for session auth
})
```

### Issue: CORS errors
**Solution**: Backend CORS should be configured in `config/cors.php` (usually handled by Laravel middleware)

### Issue: Route not found in React
**Solution**: Regenerate routes after adding new Laravel route
```bash
docker exec vivubus-app php artisan wayfinder:generate --with-form
```

### Issue: HMR not working at http://localhost:8383
**Solution**: Check Vite dev server logs
```bash
docker logs vivubus-node-watch --tail 20
```

## Summary

| Aspect | Frontend | Backend |
|--------|----------|---------|
| **Purpose** | User interface, client-side routing | Data API, business logic |
| **Tech** | React + TypeScript + Vite | Laravel + PHP |
| **Routes** | `/login`, `/register`, `/dashboard` (no /api) | `/api/login`, `/api/register`, `/api/user` (/api prefix) |
| **URLs** | `http://localhost/` or `http://localhost:8383/` | `http://localhost/api/*` |
| **Routing** | React Router (client) | Laravel routes (api.php) |
| **Helper** | `route.url()` for links | `apiUrl(route.url())` for API calls |

---

For questions or issues, check the logs:
```bash
# Frontend dev server
docker logs vivubus-node-watch --tail 50

# Backend
docker logs vivubus-app --tail 50

# Nginx proxy
docker logs vivubus-web --tail 50
```
